// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2022 The Ebitengine Authors

//go:build ignore

package main

import (
	"bytes"
	"fmt"
	"go/format"
	"log"
	"os"
	"path/filepath"
	"sort"
	"strings"
	"text/template"
)

var templateArchTrampolines = template.Must(template.New("arch_trampolines").Funcs(funcs).Parse(
	`// Code generated by 'go generate' with gen.go. DO NOT EDIT.

// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2022 The Ebitengine Authors

//go:build {{.Tag}}

#include "textflag.h"
#include "go_asm.h"

// these trampolines map the gcc ABI to Go ABI and then calls into the Go equivalent functions.
{{ range .Symbols }}
{{- if $.Arch.StackBased }}
{{- if eq .ArgsCount 0 }}
TEXT _x_cgo_{{.Name}}_trampoline(SB), NOSPLIT, $0-0
	CALL 路x_cgo_{{.Name}}(SB)
	RET
{{- else }}
TEXT _x_cgo_{{.Name}}_trampoline(SB), NOSPLIT, ${{mul .ArgsCount $.Arch.WordSize}}-0
{{- if eq $.Arch.Goarch "arm" }}
{{- range $i := .ArgsCount }}
	{{- $dstOffset := add 4 (mul $i $.Arch.WordSize) }}
	{{$.Arch.MOV}} R{{$i}}, {{$dstOffset}}(R13)
{{- end }}
	{{$.Arch.MOV}} 路_cgo_{{.Name}}_call(SB), {{$.Arch.VolatileReg}}
	{{$.Arch.MOV}} ({{$.Arch.VolatileReg}}), {{$.Arch.VolatileReg}}
{{- if $.Arch.CallNeedsParens }}
	CALL ({{$.Arch.VolatileReg}})
{{- else }}
	CALL {{$.Arch.VolatileReg}}
{{- end }}
	RET
{{- else }}
{{- $frameSize := mul .ArgsCount $.Arch.WordSize }}
{{- $retAddrSize := $.Arch.WordSize }}
{{- range $i := .ArgsCount }}
	{{- $srcOffset := add $frameSize $retAddrSize }}
	{{- $srcOffset = add $srcOffset (mul $i $.Arch.WordSize) }}
	{{- $dstOffset := mul $i $.Arch.WordSize }}
	{{$.Arch.MOV}} {{$srcOffset}}(SP), AX
	{{$.Arch.MOV}} AX, {{$dstOffset}}(SP)
{{- end }}
	{{$.Arch.MOV}} 路_cgo_{{.Name}}_call(SB), {{$.Arch.VolatileReg}}
	{{$.Arch.MOV}} ({{$.Arch.VolatileReg}}), {{$.Arch.VolatileReg}}
	CALL {{$.Arch.VolatileReg}}
	RET
{{- end }}
{{- end }}
{{- else }}
TEXT _x_cgo_{{.Name}}_trampoline(SB), NOSPLIT, ${{mul .ArgsCount $.Arch.WordSize}}
{{- range $i := .ArgsCount }}
	{{- $src := index $.Arch.C.IntRegArgs $i }}
	{{- $dst := index $.Arch.GoABI0.IntRegArgs $i }}
	{{- if ne $src $dst }}
	{{$.Arch.MOV}} {{$src}}, {{$dst}}
	{{- end }}
{{- end }}
	{{$.Arch.MOV}} 路_cgo_{{.Name}}_call(SB), {{$.Arch.VolatileReg}}
	{{$.Arch.MOV}} ({{$.Arch.VolatileReg}}), {{$.Arch.VolatileReg}}
{{- if $.Arch.CallNeedsParens }}
	CALL ({{$.Arch.VolatileReg}})
{{- else }}
	CALL {{$.Arch.VolatileReg}}
{{- end }}
	RET
{{- end }}
{{ end }}`))

var templateSymbols = template.Must(template.New("symbols").Funcs(funcs).Parse(
	`// Code generated by 'go generate' with gen.go. DO NOT EDIT.

// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2022 The Ebitengine Authors

//go:build {{.Tag}}

package fakecgo

{{ imports .Symbols }}

{{- range $di := .DynamicImports }}
{{- range $sym := $di.Symbols }}
//go:cgo_import_dynamic purego_{{ $sym }} {{ $sym }} "{{ $di.Name }}"
{{- end }}
{{- end }}

{{ range .Symbols -}}
//go:nosplit
//go:norace
func {{.Name}}(
{{- range .Args -}}
	{{- if .Name -}}
		{{.Name}} {{.Type}},
	{{- end -}}
{{- end -}}) {{.Return}} {
	{{- if .Return -}}
		{{- if eq .Return "unsafe.Pointer" -}}
			ret :=
		{{- else -}}
			return {{.Return}}(
		{{- end -}}
	{{- end -}}
call5({{.Name}}ABI0,
{{- range .Args}}
	{{- if .Name -}}
		{{- if hasPrefix .Type "*" -}}
			uintptr(unsafe.Pointer({{.Name}})),
		{{- else -}}
			uintptr({{.Name}}),
		{{- end -}}
	{{- else -}}
		0,
	{{- end -}}
{{- end -}}
	) {{/* end of call5 */}}
{{- if .Return -}}
	{{- if eq .Return "unsafe.Pointer"}}
		// this indirection is to avoid go vet complaining about possible misuse of unsafe.Pointer
		return *(*unsafe.Pointer)(unsafe.Pointer(&ret))
	{{- else -}}
		) {{/* end of cast */}}
	{{- end -}}
{{- end}}
}

{{end}}
{{- range .Symbols }}
//go:linkname _{{.Name}} _{{.Name}}
var _{{.Name}} uint8
var {{.Name}}ABI0 = uintptr(unsafe.Pointer(&_{{.Name}}))
{{ end }}
`))

var templateTrampolinesStubs = template.Must(template.New("trampolines").Parse(
	`// Code generated by 'go generate' with gen.go. DO NOT EDIT.

// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2022 The Ebitengine Authors

//go:build {{.Tag}}

#include "textflag.h"

// these stubs are here because it is not possible to go:linkname directly the C functions
{{ range .Symbols }}
TEXT _{{.Name}}(SB), NOSPLIT|NOFRAME, $0-0
	JMP purego_{{.Name}}(SB)
{{ end -}}
`))

var templateCallbacks = template.Must(template.New("callbacks").Funcs(funcs).Parse(
	`// Code generated by 'go generate' with gen.go. DO NOT EDIT.

// SPDX-License-Identifier: Apache-2.0
// SPDX-FileCopyrightText: 2022 The Ebitengine Authors

//go:build !cgo && (darwin || freebsd || linux || netbsd)

package fakecgo

import (
	_ "unsafe"
)

{{ range .Symbols }}
//go:linkname _x_cgo_{{.Name}}_trampoline _x_cgo_{{.Name}}_trampoline
//go:linkname _cgo_{{.Name}} {{if .Package}}{{.Package}}.{{end}}_cgo_{{.Name}}
var _x_cgo_{{.Name}}_trampoline byte
var _cgo_{{.Name}} = &_x_cgo_{{.Name}}_trampoline
{{- end }}

var (
	threadentry_call = threadentry
{{- range .Symbols }}
	_cgo_{{.Name}}_call = x_cgo_{{.Name}}
{{- end }}
)
`))

type Arg struct {
	Name string
	Type string
}

type Symbol struct {
	Name   string
	Args   [5]Arg
	Return string
	GOOSes []string // empty means all GOOSes
}

var (
	libcSymbols = []Symbol{
		{"malloc", [5]Arg{{"size", "uintptr"}}, "unsafe.Pointer", nil},
		{"free", [5]Arg{{"ptr", "unsafe.Pointer"}}, "", nil},
		{"setenv", [5]Arg{{"name", "*byte"}, {"value", "*byte"}, {"overwrite", "int32"}}, "int32", nil},
		{"unsetenv", [5]Arg{{"name", "*byte"}}, "int32", nil},
		{"sigfillset", [5]Arg{{"set", "*sigset_t"}}, "int32", nil},
		{"nanosleep", [5]Arg{{"ts", "*syscall.Timespec"}, {"rem", "*syscall.Timespec"}}, "int32", nil},
		{"abort", [5]Arg{}, "", nil},
		{"sigaltstack", [5]Arg{{"ss", "*stack_t"}, {"old_ss", "*stack_t"}}, "int32", []string{"netbsd"}},
	}
	pthreadSymbols = []Symbol{
		{"pthread_attr_init", [5]Arg{{"attr", "*pthread_attr_t"}}, "int32", nil},
		{"pthread_create", [5]Arg{{"thread", "*pthread_t"}, {"attr", "*pthread_attr_t"}, {"start", "unsafe.Pointer"}, {"arg", "unsafe.Pointer"}}, "int32", nil},
		{"pthread_detach", [5]Arg{{"thread", "pthread_t"}}, "int32", nil},
		{"pthread_sigmask", [5]Arg{{"how", "sighow"}, {"ign", "*sigset_t"}, {"oset", "*sigset_t"}}, "int32", nil},
		{"pthread_self", [5]Arg{}, "pthread_t", []string{"darwin"}},
		{"pthread_get_stacksize_np", [5]Arg{{"thread", "pthread_t"}}, "size_t", []string{"darwin"}},
		{"pthread_attr_getstacksize", [5]Arg{{"attr", "*pthread_attr_t"}, {"stacksize", "*size_t"}}, "int32", []string{"linux", "freebsd", "netbsd"}},
		{"pthread_attr_setstacksize", [5]Arg{{"attr", "*pthread_attr_t"}, {"size", "size_t"}}, "int32", []string{"darwin"}},
		{"pthread_attr_destroy", [5]Arg{{"attr", "*pthread_attr_t"}}, "int32", []string{"linux", "freebsd", "netbsd"}},
		{"pthread_mutex_lock", [5]Arg{{"mutex", "*pthread_mutex_t"}}, "int32", nil},
		{"pthread_mutex_unlock", [5]Arg{{"mutex", "*pthread_mutex_t"}}, "int32", nil},
		{"pthread_cond_broadcast", [5]Arg{{"cond", "*pthread_cond_t"}}, "int32", nil},
		{"pthread_setspecific", [5]Arg{{"key", "pthread_key_t"}, {"value", "unsafe.Pointer"}}, "int32", nil},
	}
)

var funcs = map[string]any{
	"hasPrefix": strings.HasPrefix,
	"imports":   imports,
	"mul":       func(a, b int) int { return a * b },
	"add":       func(a, b int) int { return a + b },
}

var GOOSes = []string{"darwin", "freebsd", "linux", "netbsd"}

func imports(symbols []Symbol) string {
	if len(symbols) == 0 {
		return ""
	}
	imports := make(map[string]struct{})
	imports["unsafe"] = struct{}{}
	for _, s := range symbols {
		for _, arg := range s.Args {
			if pkg, _, found := strings.Cut(arg.Type, "."); found {
				pkg = strings.TrimPrefix(pkg, "*")
				imports[pkg] = struct{}{}
			}
		}
	}
	if len(imports) == 1 {
		return `import "unsafe"`
	}
	result := make([]string, 0, len(imports))
	for imp := range imports {
		result = append(result, imp)
	}
	sort.Strings(result)
	var sb strings.Builder
	sb.WriteString("import (")
	for _, imp := range result {
		sb.WriteString("\n\t\"")
		sb.WriteString(imp)
		sb.WriteString("\"")
	}
	sb.WriteString("\n)")
	return sb.String()
}

// filterSymbols filters the symbols by GOOS.
// If goos is empty, it returns symbols that are not specific to any GOOS.
func filterSymbols(symbols []Symbol, goos string) []Symbol {
	filtered := make([]Symbol, 0, len(symbols))
	for _, s := range symbols {
		if (s.GOOSes == nil && goos == "") || contains(s.GOOSes, goos) {
			filtered = append(filtered, s)
		}
	}
	return filtered
}

func contains(slice []string, item string) bool {
	for _, s := range slice {
		if s == item {
			return true
		}
	}
	return false
}

func execute(t *template.Template, path string, data any) error {
	var buf bytes.Buffer
	if err := t.Execute(&buf, data); err != nil {
		return err
	}
	if filepath.Ext(path) == ".go" {
		source, err := format.Source(buf.Bytes())
		if err != nil {
			return err
		}
		buf.Reset()
		buf.Write(source)
	}
	return os.WriteFile(path, buf.Bytes(), 0644)
}

func symbolsNames(symbols []Symbol) []string {
	names := make([]string, len(symbols))
	for i, s := range symbols {
		names[i] = s.Name
	}
	return names
}

type dynamicImport struct {
	Name    string
	Symbols []string
}

type fileContent struct {
	Tag            string
	Symbols        []Symbol
	DynamicImports []dynamicImport
}

func run() error {
	allSymbols := append(append([]Symbol{}, libcSymbols...), pthreadSymbols...)
	goosAgnosticContent := fileContent{
		Symbols: filterSymbols(allSymbols, ""),
		Tag:     "!cgo && (" + strings.Join(GOOSes, " || ") + ")",
	}
	if err := execute(templateSymbols, "zsymbols.go", goosAgnosticContent); err != nil {
		return err
	}
	if err := execute(templateTrampolinesStubs, "ztrampolines_stubs.s", goosAgnosticContent); err != nil {
		return err
	}
	goosAgnosticLibCSymbols := filterSymbols(libcSymbols, "")
	goosAgnosticPthreadSymbols := filterSymbols(pthreadSymbols, "")
	for _, goos := range GOOSes {
		goosSymbols := filterSymbols(allSymbols, goos)
		var libcSO, pthreadSO string
		switch goos {
		case "darwin":
			libcSO = "/usr/lib/libSystem.B.dylib"
			pthreadSO = "/usr/lib/libSystem.B.dylib"
		case "freebsd":
			libcSO = "libc.so.7"
			pthreadSO = "libpthread.so"
		case "linux":
			libcSO = "libc.so.6"
			pthreadSO = "libpthread.so.0"
		case "netbsd":
			libcSO = "libc.so"
			pthreadSO = "libpthread.so"
		default:
			return fmt.Errorf("unsupported OS: %s", goos)
		}
		located := fileContent{
			DynamicImports: []dynamicImport{
				{libcSO, symbolsNames(append(goosAgnosticLibCSymbols, filterSymbols(libcSymbols, goos)...))},
				{pthreadSO, symbolsNames(append(goosAgnosticPthreadSymbols, filterSymbols(pthreadSymbols, goos)...))},
			},
			Symbols: goosSymbols,
			Tag:     "!cgo",
		}
		if err := execute(templateSymbols, fmt.Sprintf("zsymbols_%s.go", goos), located); err != nil {
			return err
		}
		if len(goosSymbols) != 0 {
			if err := execute(templateTrampolinesStubs, fmt.Sprintf("ztrampolines_%s.s", goos), located); err != nil {
				return err
			}
		}
	}
	for _, arch := range archs {
		if err := writeArchTrampolines(arch); err != nil {
			return err
		}
	}
	if err := execute(templateCallbacks, "zcallbacks.go", struct{ Symbols []AsmGoSymbol }{Symbols: asmGoSymbols}); err != nil {
		return err
	}
	return nil
}

type Arch struct {
	Goarch          string
	GoABI0          ABI
	C               ABI
	WordSize        int    // 4 on 32-bit systems, 8 on 64-bit systems
	MOV             string // MOV instruction, e.g., "MOVL" or "MOVQ"
	VolatileReg     string // Scratch register for intermediate values
	CallNeedsParens bool
	StackBased      bool // true if using stack-based calling convention (e.g., 386)
}

type ABI struct {
	IntRegArgs [5]string // Name of integer argument registers in order. If empty, stack-based calling convention is used.
	OutRegArg  string    // Name of the register for the single return value. If empty, stack-based calling convention is used.
}

// AsmGoSymbols are symbols that called from Go Assembly.
type AsmGoSymbol struct {
	Name      string
	ArgsCount int
	Package   string
}

var (
	archs = []Arch{
		{
			Goarch:      "386",
			WordSize:    4,
			GoABI0:      ABI{}, // stack-based calling convention
			C:           ABI{}, // stack-based calling convention
			MOV:         "MOVL",
			VolatileReg: "CX",
			StackBased:  true,
		},
		{
			Goarch:      "amd64",
			WordSize:    8,
			GoABI0:      ABI{IntRegArgs: [5]string{"AX", "BX", "CX", "DX", "SI"}, OutRegArg: "AX"},
			C:           ABI{IntRegArgs: [5]string{"DI", "SI", "DX", "CX", "R8"}, OutRegArg: "AX"},
			MOV:         "MOVQ",
			VolatileReg: "R11",
		},
		{
			Goarch:          "arm",
			WordSize:        4,
			GoABI0:          ABI{}, // stack-based calling convention
			C:               ABI{}, // stack-based calling convention
			MOV:             "MOVW",
			VolatileReg:     "R12",
			StackBased:      true,
			CallNeedsParens: true,
		},
		{
			Goarch:      "arm64",
			WordSize:    8,
			GoABI0:      ABI{IntRegArgs: [5]string{"R0", "R1", "R2", "R3", "R4"}, OutRegArg: "R0"},
			C:           ABI{IntRegArgs: [5]string{"R0", "R1", "R2", "R3", "R4"}, OutRegArg: "R0"},
			MOV:         "MOVD",
			VolatileReg: "R9",
		},
		{
			Goarch:          "loong64",
			WordSize:        8,
			GoABI0:          ABI{IntRegArgs: [5]string{"R4", "R5", "R6", "R7", "R8"}, OutRegArg: "R4"},
			C:               ABI{IntRegArgs: [5]string{"R4", "R5", "R6", "R7", "R8"}, OutRegArg: "R4"},
			MOV:             "MOVV",
			VolatileReg:     "R23",
			CallNeedsParens: true,
		},
		{
			Goarch:      "riscv64",
			WordSize:    8,
			GoABI0:      ABI{IntRegArgs: [5]string{"X10", "X11", "X12", "X13", "X14"}, OutRegArg: "X10"},
			C:           ABI{IntRegArgs: [5]string{"X10", "X11", "X12", "X13", "X14"}, OutRegArg: "X10"},
			MOV:         "MOV ",
			VolatileReg: "X5",
		},
	}
	asmGoSymbols = []AsmGoSymbol{
		{"init", 2, ""},
		{"thread_start", 1, ""},
		{"setenv", 1, "runtime"},
		{"unsetenv", 1, "runtime"},
		{"notify_runtime_init_done", 0, ""},
		{"bindm", 0, ""},
	}
)

func writeArchTrampolines(arch Arch) error {
	var gooses []string
	switch arch.Goarch {
	case "amd64", "arm64":
		gooses = []string{"darwin", "freebsd", "linux"}
	case "loong64", "riscv64":
		gooses = []string{"linux"}
	case "386":
		gooses = []string{"freebsd", "linux"}
	default:
		gooses = GOOSes
	}
	tag := "!cgo && (" + strings.Join(gooses, " || ") + ")"
	if len(gooses) == 1 {
		tag = "!cgo && " + gooses[0]
	}
	data := struct {
		Tag     string
		Symbols []AsmGoSymbol
		Arch    Arch
	}{
		Tag:     tag,
		Symbols: asmGoSymbols,
		Arch:    arch,
	}
	return execute(templateArchTrampolines, fmt.Sprintf("ztrampolines_%s.s", arch.Goarch), data)
}

func main() {
	if err := run(); err != nil {
		log.Fatal(err)
	}
}
